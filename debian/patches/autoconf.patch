Goal: move changes to autogenerated files into their own patch now that we've
      lost the script that was calling autogen.sh for us; this also helps
      make debian/rules clean just a little bit cleaner.

Fixes: no specific bug

Status wrt upstream: Debian specific

Note: This patch will normally have to be updated by hand after every
      new upstream release and after updates of any other patches that
      touch configure.in -- the first because configure scripts don't
      hold patches well between updates, the second so that our changes
      are recognized in the version of the script actually used in the
      build process.

      The process for refreshing this patch is:

 export QUILT_PATCHES=debian/patches
 quilt push autoconf.patch # to get everything applied up to this point
 quilt push -f autoconf.patch # to override the errors when applying
 (cd source && autoconf -I m4 -I lib/replace)
   # the -I lib/replace is needed because upstream seems to have done
   # something screwy with where their m4 include files are distributed in the
   # source tree; so this option may not be necessary in the future
 quilt refresh
 find . -name '*.rej' | xargs rm

Index: samba-deb/source/configure
===================================================================
--- samba-deb.orig/source/configure
+++ samba-deb/source/configure
@@ -678,6 +678,7 @@
 LIBADDNS_SOVER
 UNINSTALL_LIBADDNS
 INSTALL_LIBADDNS
+LIBADDNS_TARGET
 LIBADDNS_LIBS
 LIBADDNS_STATIC
 LIBADDNS_SHARED
@@ -686,6 +687,7 @@
 LIBSMBSHAREMODES_SOVER
 UNINSTALL_LIBSMBSHAREMODES
 INSTALL_LIBSMBSHAREMODES
+LIBSMBSHAREMODES_TARGET
 LIBSMBSHAREMODES_LIBS
 LIBSMBSHAREMODES_STATIC
 LIBSMBSHAREMODES_SHARED
@@ -694,6 +696,7 @@
 LIBSMBCLIENT_SOVER
 UNINSTALL_LIBSMBCLIENT
 INSTALL_LIBSMBCLIENT
+LIBSMBCLIENT_TARGET
 LIBSMBCLIENT_LIBS
 LIBSMBCLIENT_STATIC
 LIBSMBCLIENT_SHARED
@@ -702,6 +705,7 @@
 LIBNETAPI_SOVER
 UNINSTALL_LIBNETAPI
 INSTALL_LIBNETAPI
+LIBNETAPI_TARGET
 LIBNETAPI_LIBS
 LIBNETAPI_STATIC
 LIBNETAPI_SHARED
@@ -710,6 +714,7 @@
 LIBTDB_SOVER
 UNINSTALL_LIBTDB
 INSTALL_LIBTDB
+LIBTDB_TARGET
 LIBTDB_LIBS
 LIBTDB_STATIC
 LIBTDB_SHARED
@@ -718,6 +723,7 @@
 LIBTALLOC_SOVER
 UNINSTALL_LIBTALLOC
 INSTALL_LIBTALLOC
+LIBTALLOC_TARGET
 LIBTALLOC_LIBS
 LIBTALLOC_STATIC
 LIBTALLOC_SHARED
@@ -801,6 +807,7 @@
 MODULE_EXPORTS
 SHLD
 SONAMEFLAG
+LDDSOFLAGS
 LDSHFLAGS
 SAMBA_CPPFLAGS
 TDB_OBJS
@@ -2412,9 +2419,9 @@
 pammodulesdir="${libdir}/security"
 configdir="${libdir}"
 swatdir="\${prefix}/swat"
-codepagedir="\${MODULESDIR}"
-statedir="\${LOCKDIR}"
-cachedir="\${prefix}/cache/samba"
+codepagedir="\${prefix}/share/samba"
+statedir="\${VARDIR}/lib/samba"
+cachedir="\${VARDIR}/cache/samba"
 localedir="\${prefix}/share/locale"
 
 
@@ -2430,10 +2437,10 @@
     test "${libdir}" || libdir="\${prefix}/lib"
     modulesdir="${libdir}/samba"
     configdir="\${sysconfdir}/samba"
-    swatdir="\${DATADIR}/samba/swat"
+    swatdir="\${prefix}/swat"
     codepagedir="\${prefix}/share/samba"
     statedir="\${VARDIR}/lib/samba"
-    cachedir="\${VARDIR}/lib/samba"
+    cachedir="\${VARDIR}/cache/samba"
 
 cat >>confdefs.h <<\_ACEOF
 #define FHS_COMPATIBLE 1
@@ -11953,6 +11960,7 @@
 
 
 
+
 # compile with optimization and without debugging by default, but
 # allow people to set their own preference.
 # do this here since AC_CACHE_CHECK apparently sets the CFLAGS to "-g -O2"
@@ -13719,6 +13727,27 @@
       fi
     ;;
 
+# Systems with LFS support.
+#
+    gnu* | k*bsd*-gnu)
+	CPPFLAGS="-D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE $CPPFLAGS"
+
+cat >>confdefs.h <<\_ACEOF
+#define _LARGEFILE64_SOURCE 1
+_ACEOF
+
+
+cat >>confdefs.h <<\_ACEOF
+#define _FILE_OFFSET_BITS 64
+_ACEOF
+
+
+cat >>confdefs.h <<\_ACEOF
+#define _GNU_SOURCE 1
+_ACEOF
+
+	;;
+
 # Tests for linux LFS support. Need kernel 2.4 and glibc2.2 or greater support.
 #
     *linux*)
@@ -44065,7 +44094,7 @@
 #
 #
 case "$host_os" in
-    *linux*)
+    linux*-gnu* | gnu* | k*bsd*-gnu)
        # glibc <= 2.3.2 has a broken getgrouplist
        if test "$cross_compiling" = yes; then
   { { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
@@ -49864,6 +49893,7 @@
 # these are the defaults, good for lots of systems
 HOST_OS="$host_os"
 LDSHFLAGS="-shared"
+LDDSOFLAGS="-shared"
 MODULE_EXPORTS=""
 SONAMEFLAG="#"
 SHLD="\${CC} \${CFLAGS}"
@@ -49880,16 +49910,21 @@
 
   # and these are for particular systems
   case "$host_os" in
-		*linux*)
+		linux*-gnu* | gnu* | k*bsd*-gnu)
+			case "$host_os" in linux*)
+
 cat >>confdefs.h <<\_ACEOF
 #define LINUX 1
 _ACEOF
-
+ ;;
+			esac
 			BLDSHARED="true"
 			if test "${ac_cv_gnu_ld_no_default_allow_shlib_undefined}" = "yes"; then
-				LDSHFLAGS="-shared -Wl,-Bsymbolic -Wl,--allow-shlib-undefined"
-			else
+				LDDSOFLAGS="-shared -Wl,-Bsymbolic -Wl,--allow-shlib-undefined"
 				LDSHFLAGS="-shared -Wl,-Bsymbolic"
+			else
+				LDDSOFLAGS="-shared -Wl,-Bsymbolic"
+				LDSHFLAGS="-shared -Wl,-Bsymbolic -Wl,-z,defs"
 			fi
 			DYNEXP="-Wl,--export-dynamic"
 			PICFLAG="-fPIC"
@@ -49906,6 +49941,7 @@
 
 			BLDSHARED="true"
 			LDSHFLAGS="-G"
+			LDDSOFLAGS="$LDSHFLAGS"
 			SONAMEFLAG="-h "
 			if test "${GCC}" = "yes"; then
 				PICFLAG="-fPIC"
@@ -49918,6 +49954,7 @@
 				## ${CFLAGS} added for building 64-bit shared
 				## libs using Sun's Compiler
 				LDSHFLAGS="-G \${CFLAGS}"
+				LDDSOFLAGS="$LDSHFLAGS"
 			fi
 
 cat >>confdefs.h <<\_ACEOF
@@ -49937,6 +49974,7 @@
 
 			BLDSHARED="true"
 			LDSHFLAGS="-G"
+			LDDSOFLAGS="$LDSHFLAGS"
 			SONAMEFLAG="-Wl,-h,"
 			PICFLAG="-KPIC"   # Is this correct for SunOS
 			cat >>confdefs.h <<\_ACEOF
@@ -49951,7 +49989,6 @@
 			;;
 		*netbsd* | *freebsd* | *dragonfly* )
 			BLDSHARED="true"
-			LDSHFLAGS="-shared"
 			DYNEXP="-Wl,--export-dynamic"
 			SONAMEFLAG="-Wl,-soname,"
 			PICFLAG="-fPIC -DPIC"
@@ -49967,7 +50004,6 @@
 
 			;;
 		*openbsd*)  BLDSHARED="true"
-			LDSHFLAGS="-shared"
 			DYNEXP="-Wl,-Bdynamic"
 			SONAMEFLAG="-Wl,-soname,"
 			PICFLAG="-fPIC"
@@ -49997,6 +50033,7 @@
 			esac
 			BLDSHARED="true"
 			LDSHFLAGS="-set_version sgi1.0 -shared"
+			LDDSOFLAGS="$LDSHFLAGS"
 			SONAMEFLAG="-soname "
 			SHLD="\${LD}"
 			if test "${GCC}" = "yes"; then
@@ -50019,6 +50056,7 @@
 			# use expfull to export underscored symbols
 			# add rtl to remove /lib/crt0.o warning
 			LDSHFLAGS="-Wl,-G,-bexpfull,-bbigtoc,-brtl"
+			LDDSOFLAGS="$LDSHFLAGS"
 			DYNEXP="-Wl,-brtl,-bexpfull,-bbigtoc"
 			PICFLAG="-O2"
 			# as AIX code is always position independent...
@@ -50053,6 +50091,7 @@
 				BLDSHARED="true"
 				SHLD="cc"
 				LDSHFLAGS="-b -Wl,-B,symbolic,-b,-z"
+				LDDSOFLAGS="$LDSHFLAGS"
 				SONAMEFLAG="-Wl,+h "
 				PICFLAG="+z"
 			if test "${GCC}" = "yes"; then
@@ -50095,7 +50134,6 @@
 _ACEOF
 
 			BLDSHARED="true"
-			LDSHFLAGS="-shared"
 			SONAMEFLAG="-Wl,-soname,"
 			PICFLAG="-fPIC"
 			cat >>confdefs.h <<\_ACEOF
@@ -50124,7 +50162,6 @@
 _ACEOF
 
 			BLDSHARED="true"
-			LDSHFLAGS="-shared"
 			SONAMEFLAG="-Wl,-soname,"
 			PICFLAG="-KPIC"
 			cat >>confdefs.h <<\_ACEOF
@@ -50198,6 +50235,7 @@
 
 					fi
 					LDSHFLAGS="-G"
+					LDDSOFLAGS="$LDSHFLAGS"
                              		DYNEXP="-Bexport"
 				;;
 				*mips-sni-sysv4*)
@@ -50225,6 +50263,7 @@
 
 			fi
 			LDSHFLAGS="-G"
+			LDDSOFLAGS="$LDSHFLAGS"
 			cat >>confdefs.h <<\_ACEOF
 #define STAT_ST_BLOCKSIZE 512
 _ACEOF
@@ -50236,6 +50275,7 @@
 
 			BLDSHARED="false"
 			LDSHFLAGS=""
+			LDDSOFLAGS="$LDSHFLAGS"
 			;;
 
 		*darwin*)
@@ -50245,6 +50285,7 @@
 
 			BLDSHARED="true"
 			LDSHFLAGS="-dynamiclib -flat_namespace -undefined suppress"
+			LDDSOFLAGS="$LDSHFLAGS"
 			CFLAGS="$CFLAGS -fno-common"
 			SHLD="\${CC}"
 			SHLIBEXT="dylib"
@@ -71932,7 +71973,8 @@
 LIBTALLOC_STATIC_TARGET=bin/libtalloc.a
 LIBTALLOC_SHARED=
 LIBTALLOC_STATIC=
-LIBTALLOC_LIBS=
+LIBTALLOC_LIBS=-ltalloc
+LIBTALLOC_TARGET=
 INSTALL_LIBTALLOC=
 UNINSTALL_LIBTALLOC=
 
@@ -71947,6 +71989,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libtalloc shared library" >&5
 $as_echo_n "checking whether to build the libtalloc shared library... " >&6; }
 
@@ -71981,15 +72024,17 @@
 	UNINSTALL_LIBTALLOC=uninstalllibtalloc
 	if eval $BLDSHARED = true; then
 		LIBTALLOC_SHARED=$LIBTALLOC_SHARED_TARGET
+		LIBTALLOC_TARGET=$LIBTALLOC_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBTALLOC" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBTALLOC_LIBS=-ltalloc
+			LIBTALLOC_TARGET=$LIBTALLOC_STATIC_TARGET
+			LIBTALLOC_LIBS=$LIBTALLOC_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBTALLOC_TARGET=$LIBTALLOC_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -72016,7 +72061,8 @@
 LIBTDB_STATIC_TARGET=bin/libtdb.a
 LIBTDB_SHARED=
 LIBTDB_STATIC=
-LIBTDB_LIBS=
+LIBTDB_LIBS=-ltdb
+LIBTDB_TARGET=
 INSTALL_LIBTDB=
 UNINSTALL_LIBTDB=
 
@@ -72031,6 +72077,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libtdb shared library" >&5
 $as_echo_n "checking whether to build the libtdb shared library... " >&6; }
 
@@ -72065,15 +72112,17 @@
 	UNINSTALL_LIBTDB=uninstalllibtdb
 	if eval $BLDSHARED = true; then
 		LIBTDB_SHARED=$LIBTDB_SHARED_TARGET
+		LIBTDB_TARGET=$LIBTDB_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBTDB" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBTDB_LIBS=-ltdb
+			LIBTDB_TARGET=$LIBTDB_STATIC_TARGET
+			LIBTDB_LIBS=$LIBTDB_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBTDB_TARGET=$LIBTDB_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -72100,7 +72149,8 @@
 LIBNETAPI_STATIC_TARGET=bin/libnetapi.a
 LIBNETAPI_SHARED=
 LIBNETAPI_STATIC=
-LIBNETAPI_LIBS=
+LIBNETAPI_LIBS=-lnetapi
+LIBNETAPI_TARGET=
 INSTALL_LIBNETAPI=
 UNINSTALL_LIBNETAPI=
 
@@ -72115,6 +72165,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libnetapi shared library" >&5
 $as_echo_n "checking whether to build the libnetapi shared library... " >&6; }
 
@@ -72149,15 +72200,17 @@
 	UNINSTALL_LIBNETAPI=uninstalllibnetapi
 	if eval $BLDSHARED = true; then
 		LIBNETAPI_SHARED=$LIBNETAPI_SHARED_TARGET
+		LIBNETAPI_TARGET=$LIBNETAPI_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBNETAPI" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBNETAPI_LIBS=-lnetapi
+			LIBNETAPI_TARGET=$LIBNETAPI_STATIC_TARGET
+			LIBNETAPI_LIBS=$LIBNETAPI_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBNETAPI_TARGET=$LIBNETAPI_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -72184,7 +72237,8 @@
 LIBSMBCLIENT_STATIC_TARGET=bin/libsmbclient.a
 LIBSMBCLIENT_SHARED=
 LIBSMBCLIENT_STATIC=
-LIBSMBCLIENT_LIBS=
+LIBSMBCLIENT_LIBS=-lsmbclient
+LIBSMBCLIENT_TARGET=
 INSTALL_LIBSMBCLIENT=
 UNINSTALL_LIBSMBCLIENT=
 
@@ -72199,6 +72253,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libsmbclient shared library" >&5
 $as_echo_n "checking whether to build the libsmbclient shared library... " >&6; }
 
@@ -72233,15 +72288,17 @@
 	UNINSTALL_LIBSMBCLIENT=uninstalllibsmbclient
 	if eval $BLDSHARED = true; then
 		LIBSMBCLIENT_SHARED=$LIBSMBCLIENT_SHARED_TARGET
+		LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBSMBCLIENT" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBSMBCLIENT_LIBS=-lsmbclient
+			LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_STATIC_TARGET
+			LIBSMBCLIENT_LIBS=$LIBSMBCLIENT_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -72268,7 +72325,8 @@
 LIBSMBSHAREMODES_STATIC_TARGET=bin/libsmbsharemodes.a
 LIBSMBSHAREMODES_SHARED=
 LIBSMBSHAREMODES_STATIC=
-LIBSMBSHAREMODES_LIBS=
+LIBSMBSHAREMODES_LIBS=-lsmbsharemodes
+LIBSMBSHAREMODES_TARGET=
 INSTALL_LIBSMBSHAREMODES=
 UNINSTALL_LIBSMBSHAREMODES=
 
@@ -72283,6 +72341,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libsmbsharemodes shared library" >&5
 $as_echo_n "checking whether to build the libsmbsharemodes shared library... " >&6; }
 
@@ -72317,15 +72376,17 @@
 	UNINSTALL_LIBSMBSHAREMODES=uninstalllibsmbsharemodes
 	if eval $BLDSHARED = true; then
 		LIBSMBSHAREMODES_SHARED=$LIBSMBSHAREMODES_SHARED_TARGET
+		LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBSMBSHAREMODES" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBSMBSHAREMODES_LIBS=-lsmbsharemodes
+			LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_STATIC_TARGET
+			LIBSMBSHAREMODES_LIBS=$LIBSMBSHAREMODES_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -72352,7 +72413,8 @@
 LIBADDNS_STATIC_TARGET=bin/libaddns.a
 LIBADDNS_SHARED=
 LIBADDNS_STATIC=
-LIBADDNS_LIBS=
+LIBADDNS_LIBS=-laddns
+LIBADDNS_TARGET=
 INSTALL_LIBADDNS=
 UNINSTALL_LIBADDNS=
 
@@ -72367,6 +72429,7 @@
 
 
 
+
 { $as_echo "$as_me:$LINENO: checking whether to build the libaddns shared library" >&5
 $as_echo_n "checking whether to build the libaddns shared library... " >&6; }
 
@@ -72403,15 +72466,17 @@
 	UNINSTALL_LIBADDNS=uninstalllibaddns
 	if eval $BLDSHARED = true; then
 		LIBADDNS_SHARED=$LIBADDNS_SHARED_TARGET
+		LIBADDNS_TARGET=$LIBADDNS_SHARED_TARGET
 		{ $as_echo "$as_me:$LINENO: result: yes" >&5
 $as_echo "yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBADDNS" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBADDNS_LIBS=-laddns
+			LIBADDNS_TARGET=$LIBADDNS_STATIC_TARGET
+			LIBADDNS_LIBS=$LIBADDNS_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBADDNS_TARGET=$LIBADDNS_STATIC_TARGET
 		{ $as_echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 $as_echo "no shared library support -- will supply static library" >&6; }
 	fi
@@ -75300,7 +75365,7 @@
 $as_echo "yes" >&6; };
 
 	case "$host_os" in
-	*linux*)
+	linux*-gnu* | gnu* | k*bsd*-gnu)
 		{ $as_echo "$as_me:$LINENO: checking for linux sendfile64 support" >&5
 $as_echo_n "checking for linux sendfile64 support... " >&6; }
 if test "${samba_cv_HAVE_SENDFILE64+set}" = set; then
@@ -76562,11 +76627,11 @@
 WINBIND_NSS_PTHREAD=""
 
 case "$host_os" in
-	*linux*)
+	linux*-gnu* | gnu* | k*bsd*-gnu)
 		NSSSONAMEVERSIONSUFFIX=".2"
 		WINBIND_NSS_EXTRA_OBJS="nsswitch/winbind_nss_linux.o"
 		;;
-	*freebsd[5-9]*)
+	freebsd5*|*freebsd[6-9]*)
 		# FreeBSD winbind client is implemented as a wrapper around
 		# the Linux version.
 		NSSSONAMEVERSIONSUFFIX=".1"
Index: samba-deb/source/include/config.h.in
===================================================================
--- samba-deb.orig/source/include/config.h.in
+++ samba-deb/source/include/config.h.in
@@ -69,6 +69,9 @@
 /* Whether to use fully FHS-compatible paths */
 #undef FHS_COMPATIBLE
 
+/* Whether to use fully FHS-compatible paths */
+#undef FHS_COMPATIBLE
+
 /* Whether the host os is FreeBSD */
 #undef FREEBSD
 
